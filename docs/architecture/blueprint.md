## Convergence – System Architecture Blueprint (Enterprise, National-scale e‑Governance)

This blueprint materializes the macro-functional analysis into an implementable architecture. It is technology-concrete for the backend (Python, FastAPI) and operational database (Microsoft SQL Server), while keeping extensibility for analytics and AI capabilities.

### 1) Domain Map and Core Services
- **GOV.MGT (Governance & Management)**
  - Bounded contexts: `Hierarchy`, `Official Directory`, `Performance Reviews`, `Accountability`
  - Services: `DirectoryService`, `ReviewService`
- **SOC (Societal Awareness)**
  - Bounded contexts: `Rights & Duties`, `Education Hub`, `Campaigns`, `Sentiment`
  - Services: `AwarenessService`, `SentimentIngestor`
- **ECO (Economic Transparency)**
  - Bounded contexts: `Public Budgets`, `Procurement`, `Contracts`, `Project Monitoring`
  - Services: `BudgetService`, `ProcurementService`, `ProjectService`
- **LAW (Legal Intelligence)**
  - Bounded contexts: `Gazette Ingestion`, `Law Lifecycle`, `Legal Topics`, `Q&A`
  - Services: `LegalIngestionService`, `LegalSearchService`, `LegalQASvc`
- **CIT (Citizen Interaction & Trust)**
  - Bounded contexts: `Identity`, `Reputation`, `Feedback`, `Moderation`
  - Services: `AuthService`, `ReputationService`, `ModerationService`
- **CORE (Infrastructure & Shared Services)**
  - `AuthN/AuthZ`, `RBAC`, `Notifications`, `ETL Scheduler/Workers`, `Audit Logging`, `API Gateway`, `Observability`, `Data Governance`

Relations are event-driven where appropriate (e.g., `GazetteIngestionCompleted` → triggers `LegalIndexer`; `BudgetUploadParsed` → updates dashboards).

### 2) Layered Architecture (Logical)
- **Presentation Layer**: Web portal, mobile apps, moderator console, third-party API clients.
- **Application Service Layer** (FastAPI apps + background workers):
  - API endpoints per service (`/api/v1/...`), orchestration, validation, DTO mapping.
  - Background jobs (ETL, indexing, notifications) via scheduler.
- **Domain Layer**: Entities and domain services for Officials, Institutions, Laws, Budgets, Contracts, Campaigns, Reviews, Metrics, Users.
- **Data Layer**:
  - Operational DB: Microsoft SQL Server (OLTP).
  - Optional indices: Search/Vector index for legal text (future module).
  - Analytics: Data warehouse + lake (future phase) with lineage and masking.

Cross-cutting: Security (RBAC, policies), Observability (logging, tracing), Governance (source metadata, retention), Data Quality controls.

### 3) Technology Choices (current phase)
- **Backend**: Python 3.10–3.12, FastAPI, Pydantic v2, SQLAlchemy 2.x, Alembic.
- **DB**: Microsoft SQL Server (local dev), ODBC Driver 18 via `pyodbc`.
- **Config**: `.env` + `pydantic-settings`.
- **Logging**: `structlog` JSON logs; health and DB checks prewired.
- **Tests**: `pytest`, `httpx` (as needed), smoke tests for health endpoints.
- **Windows-first DX**: PowerShell scripts for env creation and local run.

### 4) API Design Standards
- Versioned base path: `/api/v1` (future), stable contracts, OpenAPI generated by FastAPI.
- Consistent response envelope for business endpoints: `{ status, data, error?, meta? }`.
- Errors: RFC 7807 style where appropriate; mapped exceptions (validation, not found, conflict).
- Auth: Bearer JWT (short-lived) + refresh tokens; service-to-service tokens for internal jobs.
- RBAC: Role/Permission model, least privilege, route-level and object-level policies.

### 5) Security, Compliance, Risk (Baseline Controls)
- **Legal provenance**: Entities carry `source`, `source_url`, `publication_date`, `signature/hash` when applicable.
- **Data lifecycle**: Raw → Curated → Published states; ETL jobs store `JobRun` and `SourceFile` with checksums and timestamps.
- **Privacy**: PII minimization; analytics use masking/pseudonymization; logs avoid PII by default.
- **Ethical AI**: Legal Q&A must show citations; disclaimers; no prescriptive legal advice.
- **Secret management**: `.env` for dev only; production via secret store (e.g., Key Vault, Kubernetes Secrets).
- **Transport**: TLS everywhere externally; for SQL Server use `Encrypt=yes` with trustworthy certs in prod.
- **RBAC & Auditing**: `Role`, `Permission`, `UserRole`; `LogEvent` stored for sensitive operations.
- **Backups/DR**: SQL Server backups, PITR plan; test restore procedures; migration roll-forward/rollback plans.

### 6) Data Architecture (Conceptual)
- Governance: `Institution`, `Official` (Person, Role, Tenure, PerformanceMetric)
- Societal: `Campaign`, `ContentBlock`, `LearningPath`, `Survey`, `FeedbackMetric`
- Economic: `BudgetDocument`, `BudgetLine`, `Contract`, `Supplier`, `Project`, `AuditReport`, `Indicator`
- Legal: `GazetteIssue`, `LawDocument`, `Article`, `Amendment`, `LegalTopic`, `ReferenceLink`
- Citizen: `User`, `Profile`, `Reputation`, `Review`, `Report`, `Badge`
- System: `JobRun`, `SourceFile`, `LogEvent`, `Notification`, `Role`, `Permission`, `APIKey`

High-level relationships (examples):
- `Institution` 1..* `Official` (via `Tenure`); `Official` 1..* `Review`.
- `BudgetDocument` 1..* `BudgetLine`; `BudgetLine` may link to `Contract` and `Project`.
- `GazetteIssue` 1..* `LawDocument` 1..* `Article`; `Amendment` targets `Article`.
- `User` ↔ `Reputation`; `Review` may be `Report`ed; `ModerationAction` (future) resolves.

### 7) Traceability Matrix (sample)
| Business Process | Data Entity | Actor | Output | KPI |
|---|---|---|---|---|
| Citizen rates an official | Review, Official, User | Citizen | Stored Review + Score | % Validated Reviews |
| Ministry uploads budget | BudgetDocument, Institution | Admin | Parsed Data + Charts | Data Freshness |
| Law published in Bulletin | GazetteIssue, LawDocument | External | Indexed Legal Text | Time to Index |
| Citizen asks question | Query, LawDocument | Citizen | Answer + Cited Sources | Accuracy (% with source) |
| Awareness campaign launched | Campaign, ContentBlock | Admin | Published Campaign | Reach / Engagement |

### 8) Non‑Functional Requirements (initial)
- **Availability**: ≥ 99.5% initial; scale out application replicas; SQL HA in later phase.
- **Performance**: P95 < 300ms for read APIs; background ETL out-of-band.
- **Security**: OWASP ASVS L2 baseline; periodic dependency and container scans.
- **Observability**: Correlation IDs, structured logs, health checks; tracing (OTLP) in later phase.
- **Scalability**: Stateless app layer; DB connection pooling; caching for read-heavy endpoints.
- **Migrations**: Alembic-managed, idempotent, with pre/post checks and rollback.

### 9) Deployment Topology
- **Local Dev (now)**: Single FastAPI app + SQL Server local instance. PowerShell scripts manage env/run.
- **Prod (future)**: API pods behind gateway; background worker pool; SQL Server managed instance; object storage for lake; search/vector service for LAW; centralized observability stack.

### 10) Implementation Roadmap (near-term)
1. Foundation (DONE): FastAPI skeleton, config, logging, SQL Server connectivity, health checks, tests.
2. Security scaffold: JWT auth, RBAC model, permissions middleware, audit logging.
3. GOV.MGT MVP: `Institution`, `Official`, `Tenure`, `Review` APIs (CRUD + moderation flow).
4. ECO ingestion MVP: Budget document upload + parsing pipeline; minimal dashboards (API-backed).
5. LAW ingestion MVP: Gazette fetcher + parser; store `GazetteIssue` and `LawDocument`.
6. CIT moderation MVP: Flag/resolve flows; reputation scoring baseline.
7. Observability: Request tracing, metrics, dashboards; data lineage for ETL jobs.

### 11) Python/SQL Server Implementation Notes
- **SQLAlchemy URL**: Uses `mssql+pyodbc` with `ODBC Driver 18 for SQL Server` and URL-encoded ODBC string.
- **Encryption**: For dev, `TrustServerCertificate=yes`. In production, set `Encrypt=yes` and use valid certificates; disable trust.
- **Pooling**: `pool_pre_ping=True`, tuned pool sizes; revisit under load.
- **Migrations**: Initialize Alembic, autogenerate revisions for ORM models, review before apply.
- **Testing**: Use isolated test DB/schema; seed reference data fixtures; CI executes `pytest -q`.

### 12) Open Standards and Interop
- OpenAPI 3.x, JSON responses; pagination and filtering conventions.
- Event schema (internal): JSON with `id`, `type`, `source`, `time`, `data`, correlation ID.

### 13) Next Artifacts
- Functional Specification (A): user flows, inputs/outputs, actors, validation rules.
- Logical Data Model (B): conceptual ER across domains; aligns with above entities.
- Process Flow (C): ETL → DB → API → Dashboard; lineage and quality gates.


